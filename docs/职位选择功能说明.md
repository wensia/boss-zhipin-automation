# 职位选择功能实现说明

## 功能概述

在自动化向导的登录步骤后添加了职位选择步骤，允许用户在推荐牛人页面选择要招聘的职位。

## 实现内容

### 后端实现

#### 1. 核心服务方法 (backend/app/services/boss_automation.py)

**`select_job_position(job_value: str)`** - 选择指定职位
- 自动导航到推荐页面
- 点击职位选择器打开下拉菜单
- 查找并点击匹配的职位
- 验证选择是否成功
- 支持多个候选选择器，提高稳定性

**`get_available_jobs()`** - 获取可用职位列表
- 打开职位下拉菜单
- 提取所有职位的 value 和标签信息
- 自动关闭下拉菜单

#### 2. API 端点 (backend/app/routes/automation.py)

**GET `/api/automation/available-jobs`** - 获取可用职位列表
```json
{
  "success": true,
  "jobs": [
    {
      "value": "bc9d6c8eac63563603x93dS0GVtV",
      "label": "主播（五险一金/月入过万/近地铁/福利多） _ 天津  5-10K"
    }
  ],
  "total": 5,
  "message": "获取职位列表成功"
}
```

**POST `/api/automation/select-job?job_value=xxx`** - 选择职位
```json
{
  "success": true,
  "message": "职位选择成功",
  "selected_job": "bc9d6c8eac63563603x93dS0GVtV"
}
```

### 前端实现

#### 1. API 调用方法 (frontend/src/hooks/useAutomation.ts)

添加了两个新方法：
- `getAvailableJobs()` - 获取可用职位列表
- `selectJob(jobValue)` - 选择指定职位

#### 2. 自动化向导更新 (frontend/src/pages/automation-wizard.tsx)

**步骤流程变更：**
- 旧流程：浏览器 → 登录 → 配置 → 确认
- 新流程：浏览器 → 登录 → **职位选择** → 配置 → 确认

**新增状态变量：**
```typescript
const [availableJobs, setAvailableJobs] = useState<Array<{ value: string; label: string }>>([]);
const [selectedJobValue, setSelectedJobValue] = useState<string>('');
const [loadingJobs, setLoadingJobs] = useState(false);
const [selectingJob, setSelectingJob] = useState(false);
```

**新增处理函数：**
- `loadAvailableJobs()` - 加载可用职位列表
- `handleSelectJob()` - 选择职位并进入配置步骤

**新增UI组件：**
- `renderJobSelectStep()` - 渲染职位选择步骤界面

## 测试步骤

### 后端测试

1. 运行测试脚本：
```bash
cd backend
python test_job_selection.py
```

测试脚本会：
- 初始化浏览器
- 检查登录状态
- 导航到推荐页面
- 获取可用职位列表
- 自动选择第一个职位
- 保持浏览器打开 30 秒供观察

### 前端测试

1. 启动后端服务：
```bash
cd backend
uvicorn app.main:app --reload
```

2. 启动前端开发服务器：
```bash
cd frontend
npm run dev
```

3. 测试流程：
   - 访问自动化向导页面 (http://localhost:5173/wizard)
   - 完成浏览器配置步骤
   - 完成登录步骤（扫码登录）
   - **新步骤：**查看职位选择页面
     - 应该显示可用职位列表
     - 选择一个职位
     - 点击"确认选择"按钮
   - 进入配置步骤
   - 完成后续步骤

## API 测试示例

### 测试获取职位列表

```bash
# 确保已登录
curl http://localhost:8000/api/automation/available-jobs
```

### 测试选择职位

```bash
curl -X POST "http://localhost:8000/api/automation/select-job?job_value=bc9d6c8eac63563603x93dS0GVtV"
```

## 关键特性

1. **自动加载** - 登录成功后自动加载可用职位列表
2. **多选择器支持** - 使用多个候选 CSS 选择器提高稳定性
3. **错误处理** - 提供详细的错误信息和可用职位列表
4. **状态追踪** - 在步骤指示器中显示职位选择状态
5. **用户友好** - 清晰的UI提示和加载状态

## 文件修改清单

### 后端
- ✅ `backend/app/services/boss_automation.py` - 添加职位选择方法
- ✅ `backend/app/routes/automation.py` - 添加API端点
- ✅ `backend/test_job_selection.py` - 创建测试脚本

### 前端
- ✅ `frontend/src/hooks/useAutomation.ts` - 添加API调用方法
- ✅ `frontend/src/pages/automation-wizard.tsx` - 添加职位选择步骤

## 注意事项

1. **职位 value 的格式** - 职位的 value 是一个加密字符串（如 `bc9d6c8eac63563603x93dS0GVtV`），需要精确匹配
2. **页面导航** - 选择职位前会自动导航到推荐页面
3. **下拉菜单** - 使用动态选择器定位下拉菜单元素
4. **验证机制** - 通过检查下拉菜单状态确认选择成功

## 故障排查

### 问题：无法获取职位列表
- 确保已经登录
- 检查是否在推荐页面
- 查看浏览器控制台是否有错误

### 问题：选择职位失败
- 确认 job_value 是否正确
- 检查选择器是否匹配页面元素
- 查看后端日志获取详细错误信息

### 问题：前端显示不正常
- 清除浏览器缓存
- 重新启动开发服务器
- 检查控制台错误信息
